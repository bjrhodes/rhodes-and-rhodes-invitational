---
interface Props {
  entry: any;
}

import BaseLayout from '@components/base/BaseLayout.astro';
import PageHeader from '@/components/common/PageHeader.astro';

const { entry } = Astro.props;
const { title, description, fixtures } = entry.data;
---

<BaseLayout title={title} description={description}>
  <PageHeader title={title} />
  <section class="section-sm container">
    <div class="row justify-center">
      <div class="col-10 content glass rounded-lg p-4">
        <div class="mt-8">
          <h3>Tournament Cost Calculator</h3>
          <p class="text-txt-light dark:text-darkmode-txt-light mb-6">
            Track your tournament expenses across all fixtures. We've prefilled
            costs for green fees, and left space for you to estimate travel and
            accommodation for each venue.
          </p>
          <p class="text-txt-light dark:text-darkmode-txt-light mb-6">
            Once filled in, your total cost estimate will appear at the bottom
            of the screen.
          </p>
        </div>

        <div id="costs-calculator">
          {
            fixtures.map((fixture: any, index: number) => (
              <div
                class="fixture-costs-row glass-t rounded p-4 mb-4"
                data-fixture={fixture.slug}
              >
                <h4 class="mb-4">{fixture.name}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium mb-2"
                      for={`green-fees-${index}`}
                    >
                      Green Fees (£)
                    </label>
                    <input
                      type="number"
                      id={`green-fees-${index}`}
                      class="cost-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-bg-p dark:bg-darkmode-bg-p text-txt-p dark:text-darkmode-txt-p"
                      placeholder="0.00"
                      step="0.01"
                      min="0"
                      value={fixture.fees}
                      data-cost-type="green-fees"
                      data-fixture={fixture.slug}
                    />
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium mb-2"
                      for={`travel-${index}`}
                    >
                      Travel (£)
                    </label>
                    <input
                      type="number"
                      id={`travel-${index}`}
                      class="cost-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-bg-p dark:bg-darkmode-bg-p text-txt-p dark:text-darkmode-txt-p"
                      placeholder="0.00"
                      step="0.01"
                      min="0"
                      data-cost-type="travel"
                      data-fixture={fixture.slug}
                    />
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium mb-2"
                      for={`accommodation-${index}`}
                    >
                      Accommodation (£)
                    </label>
                    <input
                      type="number"
                      id={`accommodation-${index}`}
                      class="cost-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-bg-p dark:bg-darkmode-bg-p text-txt-p dark:text-darkmode-txt-p"
                      placeholder="0.00"
                      step="0.01"
                      min="0"
                      data-cost-type="accommodation"
                      data-fixture={fixture.slug}
                    />
                  </div>
                </div>
                <div class="mt-3 text-right">
                  <span class="text-sm font-medium">
                    Fixture Total: £
                    <span class="fixture-total" data-fixture={fixture.slug}>
                      0.00
                    </span>
                  </span>
                </div>
              </div>
            ))
          }

          <div class="totals-section glass rounded-lg p-6 mt-8">
            <h3 class="mb-4">Tournament Totals</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
              <div>
                <div
                  class="text-2xl font-bold text-txt-p dark:text-darkmode-txt-p"
                >
                  £<span id="total-green-fees">0.00</span>
                </div>
                <div
                  class="text-sm text-txt-light dark:text-darkmode-txt-light"
                >
                  Green Fees
                </div>
              </div>
              <div>
                <div
                  class="text-2xl font-bold text-txt-p dark:text-darkmode-txt-p"
                >
                  £<span id="total-travel">0.00</span>
                </div>
                <div
                  class="text-sm text-txt-light dark:text-darkmode-txt-light"
                >
                  Travel
                </div>
              </div>
              <div>
                <div
                  class="text-2xl font-bold text-txt-p dark:text-darkmode-txt-p"
                >
                  £<span id="total-accommodation">0.00</span>
                </div>
                <div
                  class="text-sm text-txt-light dark:text-darkmode-txt-light"
                >
                  Accommodation
                </div>
              </div>
              <div
                class="border-l-2 border-txt-light dark:border-darkmode-txt-light pl-4"
              >
                <div
                  class="text-3xl font-bold text-txt-p dark:text-darkmode-txt-p"
                >
                  £<span id="grand-total">0.00</span>
                </div>
                <div
                  class="text-sm text-txt-light dark:text-darkmode-txt-light"
                >
                  Total Cost
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const costInputs = document.querySelectorAll('.cost-input');

    function formatCurrency(value: number): string {
      return value.toFixed(2);
    }

    function calculateTotals() {
      let totalGreenFees = 0;
      let totalTravel = 0;
      let totalAccommodation = 0;

      // Calculate fixture totals
      const fixtureSlug = new Set();
      costInputs.forEach((input) => {
        const fixture = (input as HTMLInputElement).dataset.fixture;
        if (fixture) {
          fixtureSlug.add(fixture);
        }
      });

      fixtureSlug.forEach((fixture) => {
        let fixtureTotal = 0;
        const fixtureInputs = document.querySelectorAll(
          `[data-fixture="${fixture}"]`
        );

        fixtureInputs.forEach((input) => {
          if (input.classList.contains('cost-input')) {
            const value = parseFloat((input as HTMLInputElement).value) || 0;
            const costType = (input as HTMLInputElement).dataset.costType;

            fixtureTotal += value;

            // Add to category totals
            if (costType === 'green-fees') totalGreenFees += value;
            else if (costType === 'travel') totalTravel += value;
            else if (costType === 'accommodation') totalAccommodation += value;
          }
        });

        // Update fixture total display
        const fixtureDisplay = document.querySelector(
          `.fixture-total[data-fixture="${fixture}"]`
        );
        if (fixtureDisplay) {
          fixtureDisplay.textContent = formatCurrency(fixtureTotal);
        }
      });

      // Update total displays
      const totalGreenFeesEl = document.getElementById('total-green-fees');
      const totalTravelEl = document.getElementById('total-travel');
      const totalAccommodationEl = document.getElementById(
        'total-accommodation'
      );
      const grandTotalEl = document.getElementById('grand-total');

      if (totalGreenFeesEl)
        totalGreenFeesEl.textContent = formatCurrency(totalGreenFees);
      if (totalTravelEl)
        totalTravelEl.textContent = formatCurrency(totalTravel);
      if (totalAccommodationEl)
        totalAccommodationEl.textContent = formatCurrency(totalAccommodation);
      if (grandTotalEl)
        grandTotalEl.textContent = formatCurrency(
          totalGreenFees + totalTravel + totalAccommodation
        );
    }

    // Add event listeners to all cost inputs
    costInputs.forEach((input) => {
      input.addEventListener('input', calculateTotals);
      input.addEventListener('change', calculateTotals);
    });

    // Initial calculation
    calculateTotals();
  });
</script>
